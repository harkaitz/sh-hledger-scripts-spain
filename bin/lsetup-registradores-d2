#!/bin/sh -e
##:
#h: Usage: lsetup-registradores-d2 ...
#h:
#h: ... show   : Show configuration.
#h: ... i-deps : Install wine dependencies.
#h: ... i-2023 : Install D2 in your system.
#h: ... u-2023 : Update D2 in your system.
##:
lsetup_registradores_d2() {
    local cmd="$1"
    shift
    case "${cmd}" in
        show)   lsetup_registradores_d2_show_variables ;;
        i-deps) lsetup_registradores_deps       ;;
        i-2023) lsetup_registradores_d2_i2023   ;;
        u-2023) lsetup_registradores_d2_i2023 u ;;
        *)      echo >&2 "error: Invalid argument: ${cmd}"; return 1;;
    esac
}
lsetup_registradores_d2_show_variables() {
    cat <<-EOF
	USER_PREFIX     : ${USER_PREFIX}
	REGS_WINEPREFIX : ${REGS_WINEPREFIX}
	REGS_DEPDIG2023 : ${REGS_DEPDIG2023}
	EOF
}
lsetup_registradores_d2_calc_variables() {
    USER_PREFIX="${USER_PREFIX:-${HOME}/.local}"
    REGS_WINEPREFIX="${REGS_WINEPREFIX:-${USER_PREFIX}/lib/regs64}"
    REGS_DEPDIG2023="${REGS_DEPDIG2023:-${REGS_WINEPREFIX}/drive_c/Program Files (x86)/Colegio de Registradores/DepÃ³sito digital 2023}"
}
## -------------------------------------------------------------------
lsetup_registradores_deps() {
    echo "== Installing dependencies ..."
    mkdir -p "$(dirname "${REGS_WINEPREFIX}")"
    regs_env winetricks ie8
    regs_env winetricks dotnet48
    regs_env winetricks corefonts allfonts
    if test ! -f /usr/share/fonts/TTF/marlett.ttf &&
       test   -f /usr/share/wine/fonts/marlett.ttf
    then
        sudo cp -v /usr/share/wine/fonts/marlett.ttf /usr/share/fonts/TTF/
    fi
}
lsetup_registradores_d2_i2023() {
    local i="${DDIR:-${TEMP:-/tmp}}/Instalar_D2_2023.exe"
    echo "== Installing ${REGS_WINEPREFIX} ..."
    if test -n "$1" || test ! -f "${REGS_DEPDIG2023}/ColReg.D2.Cliente.exe"; then
        if test ! -f "${i}"; then
            echo >&2 "error: ${i}: The file does not exist."
            return 1
        fi
        regs_env wine "${i}"
    fi
    echo "== Creating ${USER_PREFIX}/bin/regs-d2 ..."
    mkdir -p "${USER_PREFIX}/bin"
    cat > "${USER_PREFIX}/bin/regs-d2" <<-EOF
	#!/bin/sh -e
	export WINEPREFIX='${REGS_WINEPREFIX}'
	export WINEARCH='win64'
	if test ! -n "\${REGS_WORKDIR}"; then
	    echo >&2 'error: Please set REGS_WORKDIR environment variable.'
	    exit 1
	fi
	if test ! -d "\${REGS_WORKDIR}"; then
	    echo >&2 "error: \${REGS_WORKDIR}: The directory does not exist."
	    exit 1
	fi
	rm -rf '${REGS_WINEPREFIX}/drive_c/users/Public/Documents'
	ln -s "\${REGS_WORKDIR}" '${REGS_WINEPREFIX}/drive_c/users/Public/Documents'
	exec wine '${REGS_DEPDIG2023}/ColReg.D2.Cliente.exe' "\$@"
	EOF
    chmod +x "${USER_PREFIX}/bin/regs-d2"
}
regs_env() {
    env WINEPREFIX="${REGS_WINEPREFIX}" WINEARCH="win64" "$@"
}
## -------------------------------------------------------------------
lsetup_registradores_d2_calc_variables
if test @"${SCRNAME:-$(basename "$0")}" = @"lsetup-registradores-d2"; then
    case "${1}" in
        ''|-h|--help) sed -n 's/^ *#h: \{0,1\}//p' "$0";;
        *)            lsetup_registradores_d2 "$@"; exit 0;;
    esac
fi
